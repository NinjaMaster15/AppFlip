<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
  <title>App-Flip</title>
  <link id="-gd-engine-icon" rel="icon" type="image/png" href="AppFlip.icon.png" />
  <link rel="apple-touch-icon" href="AppFlip.apple-touch-icon.png"/>
  <style>
    html, body, #canvas { margin:0; padding:0; border:0; height:100%; width:100%; }
    body { background:black; color:white; overflow:hidden; touch-action:none; }
    #canvas { display:block; }
    #status { 
      position:absolute; top:0; left:0; right:0; bottom:0; 
      background:#242424; display:flex; justify-content:center; align-items:center; flex-direction:column;
      color:white; text-align:center; font-family:sans-serif; 
    }
    #status-progress { width:50%; margin-top:10px; }
    #status-notice { margin-top:10px; background:#5b3943; padding:1rem; border-radius:0.5rem; border:1px solid #9b3943; }
    #status-splash { max-width:100%; max-height:100%; object-fit:contain; image-rendering:pixelated; }
  </style>
</head>
<body>
  <canvas id="canvas" style="display:none;">Your browser does not support the canvas tag.</canvas>

  <div id="status">
    <img id="status-splash" src="AppFlip.png" alt="">
    <progress id="status-progress" value="0" max="100"></progress>
    <div id="status-notice"></div>
  </div>

  <script src="AppFlip.js"></script>
  <script>
    (function() {
      // üîí V√©rification du code d'acc√®s avant tout
      function verifyAccess() {
        if (localStorage.getItem("allowed") === "yes") return true;
        const code = prompt("Code d'acc√®s priv√©");
        if (code === "Yamakasi") {
          localStorage.setItem("allowed", "yes");
          return true;
        }
        return false;
      }

      if (!verifyAccess()) {
        alert("Acc√®s refus√©");
        document.body.innerHTML = "<h1 style='color:white;text-align:center;margin-top:50px;'>Acc√®s refus√©</h1>";
        return; // STOPPE TOUT LE SCRIPT, le moteur ne se lance pas
      }

      // ‚ö° Maintenant, on peut lancer Godot
      const GODOT_CONFIG = {
        args: [], canvasResizePolicy: 2, emscriptenPoolSize: 8,
        ensureCrossOriginIsolationHeaders: true, executable: "AppFlip",
        experimentalVK: false, fileSizes: {"AppFlip.pck":1388584,"AppFlip.wasm":38034280},
        focusCanvas: true, gdextensionLibs: [], godotPoolSize: 4
      };
      const GODOT_THREADS_ENABLED = false;
      const engine = new Engine(GODOT_CONFIG);

      const statusOverlay = document.getElementById('status');
      const statusProgress = document.getElementById('status-progress');
      const statusNotice = document.getElementById('status-notice');
      const canvas = document.getElementById('canvas');

      function setStatusMode(mode) {
        if (mode === 'hidden') {
          statusOverlay.style.display = 'none';
          canvas.style.display = 'block';
        } else {
          statusOverlay.style.display = 'flex';
          canvas.style.display = 'none';
          statusProgress.style.display = (mode==='progress')?'block':'none';
          statusNotice.style.display = (mode==='notice')?'block':'none';
        }
      }

      function setStatusNotice(text) { statusNotice.innerHTML = text.split('\n').join('<br>'); }

      function displayFailureNotice(err) {
        console.error(err);
        if (err instanceof Error) setStatusNotice(err.message);
        else if (typeof err==='string') setStatusNotice(err);
        else setStatusNotice('An unknown error occurred.');
        setStatusMode('notice');
      }

      const missing = Engine.getMissingFeatures({ threads:GODOT_THREADS_ENABLED });
      if (missing.length !==0) {
        displayFailureNotice('Error\nMissing features:\n' + missing.join('\n'));
      } else {
        setStatusMode('progress');
        engine.startGame({
          onProgress: (current, total) => {
            if(current>0 && total>0){ statusProgress.value=current; statusProgress.max=total; }
            else { statusProgress.removeAttribute('value'); statusProgress.removeAttribute('max'); }
          }
        }).then(()=>setStatusMode('hidden'), displayFailureNotice);
      }

    })();
  </script>
</body>
</html>

